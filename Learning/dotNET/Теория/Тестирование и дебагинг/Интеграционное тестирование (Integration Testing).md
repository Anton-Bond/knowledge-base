### üìå **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ .NET**

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫–∞–∫ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —á–∞—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –º–µ–∂–¥—É —Å–æ–±–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä:

- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ —Å–µ—Ä–≤–∏—Å—ã
- –°–µ—Ä–≤–∏—Å—ã –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–Ω–µ—à–Ω–∏–º–∏ API
- Middleware –∏ ASP.NET Core pipeline

---

## **1Ô∏è‚É£ –ü–æ–¥—Ö–æ–¥—ã –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**

üîπ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è** ‚Äì –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –µ–≥–æ —Ä–∞–±–æ—Ç—É —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏.  
üîπ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–¥–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏** ‚Äì –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–∫–∏ (Mock, Fake, In-Memory).

---

## **2Ô∏è‚É£ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏**

|–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|**TestServer**|–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ASP.NET Core API.|
|**WebApplicationFactory**|–ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏.|
|**Moq / FakeItEasy**|–ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–±–∞–∑ –¥–∞–Ω–Ω—ã—Ö, —Å–µ—Ä–≤–∏—Å–æ–≤).|
|**Respawn**|–û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º.|
|**SQLite In-Memory**|–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–π –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤.|

---

## **3Ô∏è‚É£ –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API —Å WebApplicationFactory**

–î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä:

```csharp
[ApiController]
[Route("api/products")]
public class ProductsController : ControllerBase
{
    private readonly IProductService _productService;

    public ProductsController(IProductService productService)
    {
        _productService = productService;
    }

    [HttpGet("{id}")]
    public async Task<IActionResult> GetProduct(int id)
    {
        var product = await _productService.GetProductByIdAsync(id);
        if (product == null) return NotFound();
        return Ok(product);
    }
}
```

–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç —Å **WebApplicationFactory**:

```csharp
public class ProductsControllerTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;

    public ProductsControllerTests(WebApplicationFactory<Program> factory)
    {
        _client = factory.CreateClient();
    }

    [Fact]
    public async Task GetProduct_ReturnsProduct_WhenExists()
    {
        // Act
        var response = await _client.GetAsync("/api/products/1");

        // Assert
        response.EnsureSuccessStatusCode();
        var product = await response.Content.ReadAsStringAsync();
        Assert.NotNull(product);
    }
}
```

üí° **–ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?**  
‚úÖ `WebApplicationFactory<Program>` –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.  
‚úÖ `CreateClient()` —Å–æ–∑–¥–∞—ë—Ç HTTP-–∫–ª–∏–µ–Ω—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API.  
‚úÖ `GetAsync("/api/products/1")` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP-–∑–∞–ø—Ä–æ—Å.  
‚úÖ `EnsureSuccessStatusCode()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –∫–æ–¥ `200 OK`.  
‚úÖ `Assert.NotNull(product)` —É–±–µ–∂–¥–∞–µ—Ç—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ.

---

## **4Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å TestServer**

`TestServer` –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API –±–µ–∑ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### **–ü—Ä–∏–º–µ—Ä**:

```csharp
public class ProductsApiTests
{
    private readonly TestServer _server;
    private readonly HttpClient _client;

    public ProductsApiTests()
    {
        _server = new TestServer(new WebHostBuilder()
            .UseStartup<Startup>());
        _client = _server.CreateClient();
    }

    [Fact]
    public async Task GetProduct_ReturnsNotFound_WhenProductDoesNotExist()
    {
        var response = await _client.GetAsync("/api/products/999");
        Assert.Equal(HttpStatusCode.NotFound, response.StatusCode);
    }
}
```

üîπ **–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É TestServer –∏ WebApplicationFactory**:

- `WebApplicationFactory` —É–¥–æ–±–Ω–µ–µ, –µ—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º `ASP.NET Core API`.
- `TestServer` –±–æ–ª–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ `WebHostBuilder`.

---

## **5Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö**

**–ü–æ–¥—Ö–æ–¥—ã:**  
1Ô∏è‚É£ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQLite In-Memory** ‚Äì –ª–µ–≥–∫–æ–≤–µ—Å–Ω–∞—è –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤.  
2Ô∏è‚É£ **–°–æ–∑–¥–∞–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ë–î –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º** ‚Äì –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –ø–æ–º–æ—â—å—é `Respawn`.  
3Ô∏è‚É£ **–û—á–∏—â–∞—Ç—å –∏ –∑–∞–ø–æ–ª–Ω—è—Ç—å –±–∞–∑—É –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏** ‚Äì `EnsureDeleted().EnsureCreated()`.

### **–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è In-Memory SQLite**:

```csharp
public class TestDbContextFactory
{
    public static ApplicationDbContext Create()
    {
        var options = new DbContextOptionsBuilder<ApplicationDbContext>()
            .UseInMemoryDatabase("TestDb")
            .Options;

        return new ApplicationDbContext(options);
    }
}
```

---

## **6Ô∏è‚É£ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏ (Respawn)**

`Respawn` –ø–æ–º–æ–≥–∞–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î.

### **–£—Å—Ç–∞–Ω–æ–≤–∫–∞**:

```shell
dotnet add package Respawn
```

### **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ**:

```csharp
private readonly Respawner _respawner;

public async Task InitializeAsync()
{
    _respawner = await Respawner.CreateAsync(connectionString, new RespawnerOptions
    {
        TablesToIgnore = new[] { "Migrations" }
    });
}

public async Task ResetDatabase()
{
    await _respawner.ResetAsync(connectionString);
}
```

üîπ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ**: –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –æ—á–∏—â–∞—Ç—å –ë–î –±–µ–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è.

---

## **7Ô∏è‚É£ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã **–≤–∞–∂–Ω—ã**, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.  
‚úÖ **WebApplicationFactory** –∏ **TestServer** ‚Äì –º–æ—â–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API.  
‚úÖ **In-Memory SQLite** –∏ **Respawn** ‚Äì –ø–æ–ª–µ–∑–Ω—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.  
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ **Mock** —Å–µ—Ä–≤–∏—Å–æ–≤ —Å–Ω–∏–∂–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

üîó **–ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã:**

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ WebApplicationFactory](https://learn.microsoft.com/en-us/aspnet/core/test/integration-tests)
- [GitHub Respawn](https://github.com/jbogard/Respawn)
