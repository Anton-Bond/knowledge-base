### **Общие вопросы по EF и EF Core**

1. **Что такое Entity Framework (EF)?**  
    **Ответ:** Entity Framework — это ORM (Object-Relational Mapper) для .NET, который позволяет работать с базами данных через объекты C# без необходимости писать SQL-запросы.
    
2. **Чем отличается Entity Framework Core от классического EF?**  
    **Ответ:**
    
    - EF Core кроссплатформенный и работает не только с SQL Server, но и с другими СУБД (PostgreSQL, MySQL и др.).
    - Улучшена производительность и поддержка асинхронности.
    - Убраны некоторые API (например, ObjectContext заменён на DbContext).
3. **Что такое сущность в Entity Framework?**  
    **Ответ:** Это класс, который соответствует таблице в базе данных и используется для работы с данными через DbContext.
    
4. **Какая ключевая особенность EF Core?**  
    **Ответ:** Использование **LINQ** для работы с базой данных, что позволяет писать SQL-запросы в виде C#-кода.
    

### **[[Отношения между сущностями]]**

5. **Какие виды отношений между сущностями существуют?**  
    **Ответ:**
    
    - Один к одному (1:1)
    - Один ко многим (1:M)
    - Многие ко многим (M:M)
6. **Как задать внешние ключи в Entity Framework Core?**  
    **Ответ:** Можно использовать **Data Annotations** (`[ForeignKey]`) или **Fluent API** (`HasForeignKey`).
    
7. **Что такое навигационные свойства?**  
    **Ответ:** Это свойства в классе сущности, которые позволяют обращаться к связанным объектам.
    

### **Стратегии загрузки данных**

8. **Какие существуют стратегии загрузки данных в EF Core?**  
    **Ответ:**
    - **Eager Loading** – загрузка данных сразу с зависимыми сущностями (`Include`).На уровне базы данных это `LEFT JOIN`.
    - **Lazy Loading** – отложенная загрузка при первом доступе к свойству (требует `virtual` для навигационных свойств и при конфигурации контекста данных вызвать метод `UseLazyLoadingProxies()`).
    - **Explicit Loading** – ручная загрузка с помощью `context.Entry(entity).Collection(x => x.Property).Load()` для коллекции и `context.Entry(entity).Reference(x => x.Property).Load()` если навигационное свойство представляет одиночный объект.

### **Дополнительные вопросы по связям**

9. **Может ли сущность существовать без ключа?**  
    **Ответ:** Нет, каждая сущность должна иметь **первичный ключ** (PK).
    
10. **Какие два типа организации связей существуют?**  
    **Ответ:**
    

- **Ownership** – собственный тип, полностью принадлежащий родительской сущности, через `[Owned]` атрибут.
- **Reference** – стандартное отношение между сущностями.

11. **Что такое собственные (owned) типы?**  
    **Ответ:** Это классы, которые не имеют собственного ключа и зависят от родительской сущности.
    
12. **Что такое комплексные типы в EF Core 8?**  
    **Ответ:** Это расширенные собственные типы, которые могут включать навигационные свойства, помечается атрибутом `[ComplexType]`.
    

### **Наследование в EF Core**

13. **Какие существуют стратегии маппинга при наследовании?**  
    **Ответ:**

- **Table per Hierarchy (TPH)** – одна таблица для всех наследуемых классов (столбец-дискриминатор).
- **Table per Type (TPT)** – отдельная таблица для каждого класса (с отношениями к родетельской).
- **Table per Concrete Type (TPC)** – отдельные таблицы без отношений между собой.

### **Трекер изменений и отслеживание запросов**

14. **Что делает `AsNoTracking()`?**  
    **Ответ:** Загружает данные без их отслеживания в `DbContext`, что повышает производительность при чтении.
    
15. **Чем отличаются отслеживаемые и неотслеживаемые запросы?**  
    **Ответ:**
    

- Отслеживаемые (`Tracking`) – изменения фиксируются `ChangeTracker`.
- Неотслеживаемые (`AsNoTracking`) – просто загружаются данные без их отслеживания.

16. **Что такое `ChangeTracker`?**  
    **Ответ:** Компонент EF Core, который отслеживает изменения в сущностях, загруженных в `DbContext`.

### **Запросы и производительность**

17. **Чем отличается `IEnumerable` от `IQueryable`?**  
    **Ответ:**

- `IEnumerable` – выполняется в памяти (LINQ to Objects).
- `IQueryable` – выполняется на стороне базы данных (LINQ to SQL).

18. **Как выбрать между `IEnumerable` и `IQueryable`?**  
    **Ответ:** Если данные надо фильтровать на стороне базы, использовать `IQueryable`; если в памяти – `IEnumerable`.

### **Параллелизм и конкурентность**

19. **Как решить проблему параллельного редактирования одной и той же записи?**  
    **Ответ:** Использовать **механизм конкурентности** (Concurrency Tokens, Row Version, Timestamp).
    
20. **Что такое Concurrency Token?**  
    **Ответ:** Это специальное поле в сущности, которое проверяется перед сохранением изменений, чтобы избежать конфликтов.
    
21. **Что такое Concurrency Check?**  
    **Ответ:** Атрибут `[ConcurrencyCheck]`, который помечает поле, используемое для контроля конкурентного обновления.
    
22. **Что такое Timestamp в EF Core?**  
    **Ответ:** Поле `byte[]`, используемое как версия строки для отслеживания изменений (например `Timestamp`).
    


---

### **Общие вопросы по EF Core**

1. **Что такое ORM? Какую проблему он решает?**  
    **Ответ:** ORM (Object-Relational Mapper) – это технология, которая позволяет работать с базами данных, используя объектно-ориентированные модели вместо SQL-запросов. Она решает проблему преобразования данных между реляционной моделью (таблицы) и объектной моделью (классы).
    
2. **Какие основные компоненты есть в EF Core?**  
    **Ответ:**
    
    - `DbContext` – главный объект для работы с БД.
    - `DbSet<T>` – набор данных (представляет таблицу в БД).
    - `Entity` – сущности, которые маппятся на таблицы.
    - `ChangeTracker` – отслеживание изменений в сущностях.
    - `Migrations` – механизм миграций для обновления схемы БД.
    - `LINQ` – язык запросов для работы с EF Core.
3. **Какой жизненный цикл у `DbContext`?**  
    **Ответ:**
    
    - Создание объекта `DbContext`.
    - Использование для выполнения операций с БД.
    - Автоматическое или явное отслеживание изменений.
    - Сохранение изменений через `SaveChanges()`.
    - Освобождение ресурсов (`Dispose`).

---

### **Моделирование и настройка сущностей**

4. **Как задать первичный ключ в EF Core?**  
    **Ответ:** Через атрибут `[Key]`, аннотацию `HasKey()` или автоинкрементный ключ `Id` по умолчанию.
    
5. **Можно ли использовать составные ключи в EF Core? Как?**  
    **Ответ:** Да, через `HasKey()` в `Fluent API`.
    
6. **Как настроить автоинкрементный ключ?**  
    **Ответ:** По умолчанию EF Core использует `IDENTITY` в SQL Server, но можно настроить вручную через `ValueGeneratedOnAdd()`.
    
7. **Что такое ValueGeneratedOnAdd и ValueGeneratedOnUpdate?**  
    **Ответ:**
    
    - `ValueGeneratedOnAdd()` – генерирует значение при вставке.
    - `ValueGeneratedOnUpdate()` – генерирует новое значение при обновлении.

---

### **Связи между сущностями**

8. **Как реализовать отношение "один ко многим" в EF Core?**  
    **Ответ:**
    
    - Навигационные свойства в классах.
    - Внешний ключ (`ForeignKey`).
    - `HasOne().WithMany()` в Fluent API.
9. **Как создать связь "многие ко многим" в EF Core 5+ без промежуточной сущности?**  
    **Ответ:** Начиная с EF Core 5, можно использовать `HasMany().WithMany()` без отдельной таблицы-связки.
    
10. **Как принудительно загрузить связанные данные, если используется `Lazy Loading`?**  
    **Ответ:** Использовать `context.Entry(entity).Reference(x => x.Property).Load();` или `context.Entry(entity).Collection(x => x.Property).Load();`.
    

---

### **Работа с базой данных**

11. **Как добавить сущность в базу данных?**
    
    ```csharp
    var entity = new User { Name = "John" };
    context.Users.Add(entity);
    context.SaveChanges();
    ```
    
12. **Как обновить сущность?**
    
    ```csharp
    var entity = context.Users.FirstOrDefault(u => u.Id == 1);
    entity.Name = "Updated Name";
    context.SaveChanges();
    ```
    
13. **Как удалить сущность?**
    
    ```csharp
    var entity = context.Users.Find(1);
    context.Users.Remove(entity);
    context.SaveChanges();
    ```
    
14. **Что делает `SaveChanges()` в EF Core?**  
    **Ответ:** Фиксирует все изменения в `ChangeTracker`, генерирует SQL-команды и отправляет их в базу.
    
15. **Как откатить изменения в `DbContext` перед `SaveChanges()`?**  
    **Ответ:** Использовать `context.ChangeTracker.Clear();`.
    

---

### **Запросы и производительность**

16. **Чем отличается `FirstOrDefault()` от `SingleOrDefault()`?**  
    **Ответ:**
    
    - `FirstOrDefault()` – возвращает первый элемент, если он есть, или `null`.
    - `SingleOrDefault()` – ожидает максимум одну запись, если больше – выбросит исключение.
17. **Чем отличается `IQueryable` от `IEnumerable`?**  
    **Ответ:**
    
    - `IQueryable` выполняется на стороне БД (LINQ to SQL).
    - `IEnumerable` выполняется в памяти (LINQ to Objects).
18. **Что делает `AsNoTracking()`?**  
    **Ответ:** Загружает данные без их отслеживания в `DbContext`, улучшая производительность.
    
19. **Как загрузить только нужные поля из таблицы (проекция)?**
    
    ```csharp
    var users = context.Users.Select(u => new { u.Id, u.Name }).ToList();
    ```
    
20. **Как выполнить SQL-запрос в EF Core?**
    
    ```csharp
    var users = context.Users.FromSqlRaw("SELECT * FROM Users").ToList();
    ```
    

---

### **Трекер изменений и конкурентность**

21. **Как работает `ChangeTracker` в EF Core?**  
    **Ответ:**
    
    - Отслеживает изменения в сущностях.
    - Позволяет откатывать изменения.
    - Автоматически обновляет состояния (`Added`, `Modified`, `Deleted`).
22. **Как решить проблему параллельного редактирования одной записи?**  
    **Ответ:** Использовать **Concurrency Token**, `RowVersion` или `Timestamp`.
    
23. **Как включить поддержку `RowVersion` в EF Core?**
    
    ```csharp
    public class User
    {
        public int Id { get; set; }
        public string Name { get; set; }
        [Timestamp]
        public byte[] RowVersion { get; set; }
    }
    ```
    
24. **Что произойдёт, если два пользователя изменят одну и ту же запись?**  
    **Ответ:** EF Core выбросит `DbUpdateConcurrencyException`, если включена поддержка конкурентности.
    

---

### **Миграции и настройки базы**

25. **Как создать миграцию в EF Core?**
    
    ```sh
    dotnet ef migrations add InitialCreate
    ```
    
26. **Как применить миграции в базу данных?**
    
    ```sh
    dotnet ef database update
    ```
    
27. **Как удалить последнюю миграцию?**
    
    ```sh
    dotnet ef migrations remove
    ```
    
28. **Как настроить альтернативный провайдер БД (например, PostgreSQL)?**
    
    ```csharp
    optionsBuilder.UseNpgsql("Host=myserver;Database=mydb;Username=myuser;Password=mypass");
    ```
    

---
