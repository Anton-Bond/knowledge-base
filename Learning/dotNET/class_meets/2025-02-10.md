## **Базы данных и проектирование.**

Что такое SQL?
Какие задачи решает?
Что означает в контексте дотнета? (это ORM)
JOIN это?
Виды JOIN: INNER, LEFT, RIGHT, OUTER (он очень медленный)
Основные замечания? (отсутсвие индекса приводит к замедлению запроса, ссылка на форен кей и другие (перечисли))
Многократный LEFT JOIN, нюансы? (проверять на наличие значения)

Индексы это?
Два типа: кластеризованные и некластеризованные.
Подводные камни: увеличение размера базы данных, вставка новых записей становится медленной, дефрагметация и другие (перечисли)?

хранимая процедура?
преимущества и недостатки?
подводные камни: сложная поддерка, и другие (перечисли)?

Тригеры это?
Основные проблемы: скрытые операции, замедляют работу и другие (перечисли)?


ORM это?
Для чего он важен?
ORM в .NET? (Dapper, ADO.NET, Entity Framework Core)
Плюсы и минусы каждого?
Entity Framework Core? (изи ту старт, хард ту эксперт)
Dapper? когда его использовать ? (гибкость управл эскл, быстрее, для высконагруж запросов)
ADO.NET?

Транзакции это?
ACID это? (свойство транзакции)
4 свойства: атомарность, согласованность, изоляция (уровни изоляции), долгвечность?
Как работать с транзакциями?
Транзакшн скоуп?

```C#
using (var scope = new TransactionScope())
{
	context.Accounts.First(a => a.Id == 1).Balance -= 500;
	context.Accounts.First(a => a.Id == 2).Balance += 500;
	context.SaveChanges();
	scope.Complete(); // Если мы не вызовем .Complete(), произойдет откат
}
```

Плюсы и минусы транзакций? 
Если транз скоуп слишком глобальный?
```C#
using (var transaction = context.Database.BeginTransaction())
{
	try
	{
		context.Accounts.First(a => a.Id == 1).Balance -= 500;
		context.Accounts.First(a => a.Id == 2).Balance += 500;
		context.SaveChanges();
		transaction.Commit(); // Сохраняем изменения
	}
	catch
	{
		transaction.Rollback(); // Если ошибка - откат
	}
}
```
Уровни изоляции?  (обязательно знать!!!)
Дэдлоки?

``` SQL
BEGIN TRANSACTION;
UPDATE Accounts SET Balance = Balance - 500 WHERE Id = 1;
WAITFOR DELAY '00:00:10';
UPDATE Accounts SET Balance = Balance + 500 WHERE Id = 2;
COMMIT TRANSACTION;
```

Как избежать дэдлоков? (проверять не заболчен ли ресурс, использовать ноу лок, исп роулок и ...., переключ в )

```SQL
SELECT * FROM Accounts WITH (NOLOCK);

UPDATE Accounts WITH (UPDLOCK, ROWLOCK) SET Balance = Balance - 500 WHERE Id = 1;
```

Проектирование баз данных?
Принципы проектирования?
Скалироваемость, целостность данных, производительность и гикость?
Ошибки которые необходимо избегать? (отсутствие нормализации, избегать слишком сложных схем, проблемы отсутствия индексов или излишки их, отсутствие четких связей)
Три осн формы нормализации (примеры ниже):
 - первая-отсутствие повторяемых групп данных.
 - вторая-данные должны зависить только от первичного ключа.
 - третья-отсутствие транзитивных зависимостей.
 
Денормализация таблицы это?
Процесс "управление сложностью" это? (из зол выбирать меншее)

##### **Первая**
*плохо*
```SQL
CREATE TABLE Orders ( Id INT PRIMARY KEY, Products VARCHAR(255); -- Список товаров в одной колонке (нарушение 1NF))
```
 *исправленно*
 ```SQL
CREATE TABLE OrderItems ( OrderId INT, ProductId INT, PRIMARY KEY (OrderId, ProductId));
```

##### **Вторая**
*плохо*
```SQL
CREATE TABLE Employee (
	EmployeeId INT PRIMARY KEY,
	Name VARCHAR(100),
	DepartmentName VARCHAR(100), -- Зависит от DepartmentId, а не от EmployeeId
	DepartmentLocation VARCHAR(100)
);
```
*исправленно*
```SQL
CREATE TABLE Department ( 
	DepartmentId INT PRIMARY KEY,
	Name VARCHAR(100),
	Location VARCHAR(100)
);
  
CREATE TABLE Employee (
	EmployeeId INT PRIMARY KEY,
	Name VARCHAR(100),
	DepartmentId INT,
	FOREIGN KEY (DepartmentId) REFERENCES Department(DepartmentId)
);
```

##### **Третья**
*плохо*
```SQL
CREATE TABLE Customer (
	CustomerId INT PRIMARY KEY,
	Name VARCHAR(100),
	ZipCode VARCHAR(10),
	City VARCHAR(100)
);
```
 *исправленно*
```SQL
CREATE TABLE City (
	ZipCode VARCHAR(10) PRIMARY KEY,
	CityName VARCHAR(100)
);

CREATE TABLE Customer (
	CustomerId INT PRIMARY KEY,
	Name VARCHAR(100),
	ZipCode VARCHAR(10),
	FOREIGN KEY (ZipCode) REFERENCES City(ZipCode)
);
```

